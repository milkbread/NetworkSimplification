<html>
<head>
	<title>Playing with quadtrees</title>
	<script src="d3.v3.min.js"></script>
	<script src="functions.js"></script>
	<link rel="stylesheet" href="styles.css" />
	<script src="sidebar.js"></script>
	<link rel="stylesheet" href="sidebar.css" />
</head>
<body>
<script type="text/javascript">
	// Concept for a DataPoint-Class
	// function DataPoint(input) {
	// 	var self = this;
	// 	self.coords = input.coords;
	// }

	// Basic variables
	var width = 730,
	    height = 600,
	    scale = 280,
		groupScale = 1,
		groupPositionX = oldGroupPositionX = 0,
		groupPositionY = oldGroupPositionY = 0;

	var container = d3.select("body").append("div")
	    .attr("width", 960)
	    .attr("height", height)
	    .attr("class", "mainContainer");

	// prepare the major SVG-Visualisation area
	var svg = container.append("div").attr("id", "svgContainer")
		.append("svg")
		    .attr("width", width)
		    .attr("height", height)
		    .on("mousedown", startMoving)
		    .on("mouseup", stopMoving)
			.call(
		    	d3.behavior.zoom().on("zoom", reScale)
			);

	// prepare the SVG-Groups and corresponding object-variables
	var qGroupLines = svg.append("g").attr("id", "qGroupLines").attr("visibility", "hidden"),
		qGroupPoints = svg.append("g").attr("id", "qGroupPoints").attr("visibility", "hidden"),
		pointGroup = svg.append("g").attr("id", "pointGroup").attr("visibility", "hidden"),
		lineGroup = svg.append("g").attr("id", "lineGroup"),
		consPointGroup = svg.append("g").attr("id", "consPointGroup"),
		qRectLines, qRectPoints, points, lines, constrainingPoints;

	// Build an array of group-objects
	var groups = [
		{	name: "quadtreeLines",
			description: "Quadtree - lines",
			group: qGroupLines,
			init:false},
		{	name: "quadtreePoints",
			description: "Quadtree - points",
			group: qGroupPoints,
			init:false},
		{	name: "points",
			description: "Points of lines",
			group: pointGroup,
			init:false},
		{	name: "lines",
			description: "Lines",
			group: lineGroup,
			init:true},
		{	name: "consPoints",
			description: "Constraining points",
			group: consPointGroup,
			init:true}
	];

	// Create some sidebar elements
	var sidebarContainer = container.append("div").attr("id", "sidebarContainer");
	var toolbar = new Toolbar(sidebarContainer, groups, "Select Elements");
	var lineSelector = new Selector(sidebarContainer, "Select a line");
	var pointNumberSelector = new Selector(sidebarContainer, "Number to remove");

	// Render all geometries in the corresponding groups
	function renderData(lineData, pointData) {

		var extent = getExtent(lineData); //[[minX, minY], [maxX, maxY]]
		function projection(d) { return [(d[0]-extent[0][0]) * scale, (d[1]-extent[0][1]) * scale]; }

		// Add area of triangle to each feature
		lineData.features.forEach(function(feature) {
			addTriangleSize(feature.geometry, projection);
			feature = rankAfterTriangles(feature);
		});

		var path = d3.geo.path()
				.projection(projection),
			linesDataPoints = getAllPoints(lineData, projection),
			consDataPoints = getAllPoints(pointData, projection);

		// Inititialise the quadtree
		var rawQuadtree = d3.geom.quadtree();
		// rawQuadtree.extent(extent)			//can generate: 'Maximum call stack size exceeded'
		var quadtreeLines = rawQuadtree(linesDataPoints);
		var quadtreePoints = rawQuadtree(consDataPoints);

		// Draw the rectangles of the quadtree of all points of all lines
		qRectLines = qGroupLines.selectAll(".node")
		    .data(nodes(quadtreeLines))
				.enter().append("rect")
					.attr("x", function(d) { return d.x; })
					.attr("y", function(d) { return d.y; })
					.attr("width", function(d) { return d.width; })
					.attr("height", function(d) { return d.height; });

		// Draw the rectangles of the quadtree of the constraining points
		qRectPoints = qGroupPoints.selectAll(".node")
		    .data(nodes(quadtreePoints))
				.enter().append("rect")
					.attr("x", function(d) { return d.x; })
					.attr("y", function(d) { return d.y; })
					.attr("width", function(d) { return d.width; })
					.attr("height", function(d) { return d.height; });

		// Draw all points of the lines
		points = pointGroup.selectAll(".point")
			.data(linesDataPoints)
				.enter().append("circle")
					.attr("class", "point")
					.attr("cx", function(d) { return d[0]; })
					.attr("cy", function(d) { return d[1]; });

		// Draw all lines
		lines = lineGroup.selectAll(".line")
			.data(lineData.features)
				.enter().append("path")
					.attr("d", function(d){ return path(d.geometry); })
					.attr("class", "line")
					.attr("id", function(d) { return "line" + d.properties.id });

		// Draw the constraining points
		constrainingPoints = consPointGroup.selectAll(".consPoint")
			.data(pointData.features)
				.enter().append("circle")
					.attr("cx", function(d) { return projection(d.geometry.coordinates)[0]; })
					.attr("cy", function(d) { return projection(d.geometry.coordinates)[1]; })
					.attr("class", "consPoint");

		transformGroup();

		// Add the line-selector to the sidebar and add action for the selected line
		lineSelector.addElements(lineData.features, "Line");
		lineSelector.select
			// Add an action for the change of the 'lineSelector'
			.on("change", function() {
				addSimplificationSelector(lineSelector.selectedID(), path);
			});

		// initially select the first line
		addSimplificationSelector(1, path)

	}
	// Load lineData & pointData and do visualisations
	d3.json("lines.json", function(error, lineData) {
		d3.json("points.json", function(error, pointData) {
			renderData(lineData, pointData);
		});
	});

</script>
</body>
</html>