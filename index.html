<html>
<head>
	<title>Playing with quadtrees</title>
	<script src="d3.v3.min.js"></script>
	<script src="functions.js"></script>
	<link rel="stylesheet" href="styles.css" />
	<script src="sidebar.js"></script>
	<link rel="stylesheet" href="sidebar.css" />
</head>
<body>
<script type="text/javascript">
	// Concept for a DataPoint-Class
	// function DataPoint(input) {
	// 	var self = this;
	// 	self.coords = input.coords;
	// }

	// Basic variables
	var width = 730,
	    height = 600,
	    scale = 280,
		groupScale = 1,
		groupPositionX = oldGroupPositionX = 0,
		groupPositionY = oldGroupPositionY = 0;

	var container = d3.select("body").append("div")
	    .attr("width", 960)
	    .attr("height", height)
	    .attr("class", "mainContainer");

	// prepare the major SVG-Visualisation area
	var svg = container.append("div").attr("id", "svgContainer")
		.append("svg")
		    .attr("width", width)
		    .attr("height", height)
		    .on("mousedown", startMoving)
		    .on("mouseup", stopMoving)
			.call(
		    	d3.behavior.zoom().on("zoom", reScale)
			);

	// prepare the SVG-Groups and corresponding object-variables
	var rectGroup = svg.append("g").attr("id", "rectGroup"),
		pointGroup = svg.append("g").attr("id", "pointGroup"),
		lineGroup = svg.append("g").attr("id", "lineGroup"),
		consPointGroup = svg.append("g").attr("id", "consPointGroup"),
		rectangles, points, lines, constrainingPoints;

	var groups = [
		{name: "rects", description: "Rectangles", group: rectGroup},
		{name: "points", description: "Points of lines", group: pointGroup},
		{name: "lines", description: "Lines", group: lineGroup},
		{name: "consPoints", description: "Constraining points", group: consPointGroup}
	];

	// Create some sidebar elements
	var sidebarContainer = container.append("div").attr("id", "sidebarContainer");
	var toolbar = new Toolbar(sidebarContainer, groups, "Select Elements");
	var lineSelector = new Selector(sidebarContainer, "Select a line");
	var pointNumberSelector = new Selector(sidebarContainer, "Number to remove");

	function processData(lineData, pointData) {
		lineSelector.addElements(lineData.features, "Line");
		// Add an action for the change of the 'lineSelector'
		lineSelector.option
			.on("change", function() {
				var numberOfPoints = lineData.features[parseInt(lineSelector.selectedID())].geometry.coordinates.length
				if (numberOfPoints > 2) {
					pointNumberSelector.addElements(d3.range(numberOfPoints-1).map(function(d) {return {properties: {id: d}}}), "");
				} else {
					pointNumberSelector.throwException("Nop...number of points is <= 2!");
				}
			});

		var extent = getExtent(lineData); //[[minX, minY], [maxX, maxY]]
		function projection(d) { return [(d[0]-extent[0][0]) * scale, (d[1]-extent[0][1]) * scale]; }
		var path = d3.geo.path()
				.projection(projection),
			dataPoints = getAllPoints(lineData, extent, projection);

		// Inititialise the quadtree
		var rawQuadtree = d3.geom.quadtree();
		// rawQuadtree.extent(extent)			//can generate: 'Maximum call stack size exceeded'
		var quadtree = rawQuadtree(dataPoints);

		// Draw all rectangles by using a collapsed quadtree
		rectangles = rectGroup.selectAll(".node")
		    .data(nodes(quadtree))
				.enter().append("rect")
					.attr("x", function(d) { return d.x; })
					.attr("y", function(d) { return d.y; })
					.attr("width", function(d) { return d.width; })
					.attr("height", function(d) { return d.height; })

		// Draw all points of the lines
		points = pointGroup.selectAll(".point")
			.data(dataPoints)
				.enter().append("circle")
					.attr("class", "point")
					.attr("cx", function(d) { return d[0]; })
					.attr("cy", function(d) { return d[1]; });

		// Draw all lines
		lines = lineGroup.selectAll(".line")
			.data(lineData.features)
				.enter().append("path")
					.attr("d", function(d){ return path(d.geometry); })
					.attr("class", "line")
					.attr("id", function(d) { return d.properties.id });

		// Draw the constraining points
		constrainingPoints = consPointGroup.selectAll(".consPoint")
			.data(pointData.features)
				.enter().append("circle")
					.attr("cx", function(d) { return projection(d.geometry.coordinates)[0]; })
					.attr("cy", function(d) { return projection(d.geometry.coordinates)[1]; })
					.attr("class", "consPoint");

		transformGroup();
	}
	// Load lineData & pointData and do visualisations
	d3.json("lines.json", function(error, lineData) {
		d3.json("points.json", function(error, pointData) {
			processData(lineData, pointData);
		});
	});

</script>
</body>
</html>